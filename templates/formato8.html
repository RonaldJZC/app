<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formato 8 EQUIPAMIENTO</title>

  <!-- Tu CSS principal -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- OJO: ya NO usamos estilos de dropdown/sugerencias -->
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="{{ url_for('static', filename='img/logominsa.png') }}" alt="logominsa">
    <div class="title">
      <div class="h1">Formato 8 Plan Multianual de Equipamiento</div>
      <div class="h2">OFICINA DE INFRAESTRUCTURA Y EQUIPAMIENTO — ING. ELECTÓNICO RONALD ZARPAN CASAS</div>
    </div>
  </div>
  <div class="header-actions">
    <a class="btn red" href="{{ url_for('auth.logout') }}">Salir</a>
  </div>
</header>

<div class="wrap">

  <div class="toast"><b>Emisión!</b> El Documento solo puede ser emitido por: <b>Firmado Por</b></div>

  <div class="card">
    <div class="card-head">
      <div class="title">EMISIÓN DE DOCUMENTOS ADMINISTRATIVOS</div>
      <div class="toolbar">
        <a class="btn blue" href="#">Grabar</a>
        <a class="btn blue" href="#">Firmar Doc.</a>
        <a class="btn" href="#">Ver / Cargar Anexos</a>
        <a class="btn" href="#">Cargar SIGA</a>
        <a class="btn gray" href="#">Anular</a>
        <a class="btn" href="#">Cerrar</a>
        <a class="btn red" href="{{ url_for('auth.logout') }}">Salir</a>
      </div>
    </div>

    <div class="card-body">

      <!-- Datos de Unidad Ejecutora -->
      <section class="section">
        <div class="section-title">Datos de Unidad Ejecutora</div>
        <div class="grid cols-4">
          <div class="field">
            <label>Pliego</label>
            <input id="pliego" name="pliego" type="text" value="{{ pliego_texto }}" readonly>
          </div>

          <div class="field">
            <label>Unidad Ejecutora</label>
            <input id="unidad_ejecutora" name="unidad_ejecutora" type="text" value="{{ ue_texto }}" readonly>
          </div>

          <div class="field">
            <label>Código IPRESS</label>
            <input id="ipress_codigo" name="ipress_codigo" type="text" readonly>
          </div>

          <!-- SOLO input (sin dropdown). Enter hará la búsqueda en el server -->
          <div class="field">
            <label>Establecimiento de Salud</label>
            <input id="establecimiento" name="establecimiento" placeholder="Escribe el nombre y presiona Enter" autocomplete="off">
          </div>

          <div class="field">
            <label>Categoria del EESS</label>
            <input id="categoria_eess" name="categoria_eess" type="text" readonly>
          </div>
        </div>
      </section>

      <!-- Datos del equipo (sin cambios) -->
      <section class="section">
        <div class="row"><div class="section-title">Datos del equipo</div></div>
        <div class="grid cols-3">
          <div class="field"><label>CODIGO PATRIMONIAL</label><input id="codigo_patrimonial"></div>
          <div class="field"><label>AMBIENTE</label><input value="LABORATORIO"></div>
          <div class="field"><label>UNIDAD PRESTADORA DE SERVICIO DE SALUD (UPSS)</label><input value="UPSS PATOLOGIA CLINICA"></div>
          <div class="field"><label>DENOMINACION DEL EQUIPAMIENTO EXISTENTE</label><input id="denominacion"></div>
          <div class="field"><label>MARCA</label><input id="marca"></div>
          <div class="field"><label>MODELO</label><input id="modelo"></div>
          <div class="field"><label>SERIE / PLACA DE RODAJE</label><input id="serie"></div>
          <div class="field"><label>ANTIGUEDAD</label><input id="antiguedad"></div>
          <div class="field"><label>VIDA ÚTIL</label><input value="5"></div>
        </div>
      </section>

      <!-- Evaluación de Equipamiento (sin cambios) -->
      <section class="section">
        <div class="section-title">Evaluación de Equipamiento</div>
        <div class="grid cols-4">
          <div class="field">
            <label>Tipo de Equipamiento</label>
            <select>
              <option>Biomedico</option>
              <option>Electromedicino</option>
              <option>Moviliario Clinico</option>
            </select>
          </div>
          <div class="field"><label>C1</label><input value="X"></div>
          <div class="field"><label>C2</label><input value="X"></div>
          <div class="field"><label>C3</label><input value="X"></div>
          <div class="field"><label>C4</label><input value="X"></div>
          <div class="field"><label>C5</label><input value="X"></div>
          <div class="field"><label>C6</label><input value="X"></div>
        </div>

        <div class="field" style="margin-top:8px">
          <label>Asunto</label>
          <textarea>SOLICITO REPARACION DE ESTERILIZADOR DEL SERVICIO DE ODONTOLOGIA DEL PS SAN ROQUE - EQUIPO OPERATIVO</textarea>
        </div>

        <div class="grid cols-4" style="margin-top:8px">
          <div class="field"><label>CONDICION DE SEGURIDAD (requiere informe tecnico)</label><input></div>
          <div class="field"><label>SUSTENTO DE EVALUACION (C2-C3-C4-C6-C7)</label><input ></div>
          <div class="field"></div>
          <div class="field"></div>
        </div>
      </section>

      <!-- Presupuesto (sin cambios) -->
      <section class="section">
        <div class="section-title">Presupuesto</div>
        <div class="grid cols-4">
          <div class="field">
            <label>PROGRAMA PRESUPUESTAL</label>
            <select>
              <option>0001</option><option>0002</option><option>0016</option><option>0017</option>
              <option>0018</option><option>0024</option><option>0068</option><option>0104</option>
              <option>0129</option><option>0131</option><option>1001</option>
            </select>
          </div>
          <div class="field"><label>PRODUCTO</label><select><option>—</option></select></div>
          <div class="field"><label>ACTIVIDAD</label><select><option>—</option></select></div>
          <div class="field"><label>GRUPO-CLASE-FAMILIA DEL EQUIPO A ADQUIRIR</label><select><option>—</option></select></div>
          <div class="field"><label>DENOMINACION DEL EQUIPAMIENTO A ADQUIRIR</label><input></div>
          <div class="field"><label>COSTO REFERENCIAL  DEL EQUIPAMIENTO</label><input></div>
          <div class="field">
            <label>PRIORIDAD MULTIANUAL (1 -AÑO 2023,2-AÑO 2024,3-AÑO 2025)</label>
            <select><option>1</option><option>2</option><option>3</option></select>
          </div>
        </div>

        <div class="footer">
          <div>Equipo: Trámite Documentario — Versión 2.5</div>
          <div>Unidad Orgánica: OFICINA DE INFRAESTRUCTURA Y EQUIPAMIENTO — DIRIS LIMA SUR</div>
        </div>
      </section>

    </div>
  </div>
</div>

</body>

<!-- Script 1: asegura que Pliego y UE queden readonly (igual que antes) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const pliego = "{{ pliego_texto|e }}";
  const ue = "{{ ue_texto|e }}";
  const $pliego = document.querySelector('#pliego, #pliego_input, [name="pliego"]');
  const $ue = document.querySelector('#unidad_ejecutora, #ue_input, [name="unidad_ejecutora"]');
  if ($pliego) { $pliego.value = pliego; $pliego.setAttribute('readonly', 'readonly'); }
  if ($ue) { $ue.value = ue; $ue.setAttribute('readonly', 'readonly'); }
});
</script>

<!-- Script 2: BUSCAR EN SERVER AL PRESIONAR ENTER (sin dropdown) -->
<script>
  const $input = document.getElementById('establecimiento');
  const $ipr   = document.getElementById('ipress_codigo');
  const $cat   = document.getElementById('categoria_eess');

  // Normaliza texto (útil para match exacto ignorando tildes)
  const norm = s => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

  async function buscarServidor(q) {
    try {
      const res = await fetch("{{ url_for('views.api_ipress_search') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ q })
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json(); // [{ipress_codigo, eess_nombre, eess_categoria}, ...]
    } catch (err) {
      console.error("Error buscando IPRESS:", err);
      return [];
    }
  }

  function aplicarSeleccion(r) {
    if (!r) return;
    $input.value = r.eess_nombre;
    $ipr.value   = r.ipress_codigo || '';
    $cat.value   = r.eess_categoria || '';
  }

  // 1) Enter: busca y rellena el mejor resultado (o el exacto si coincide)
  $input.addEventListener('keydown', async (e) => {
    if (e.key !== 'Enter') return;
    e.preventDefault();
    const q = $input.value.trim();
    if (q.length < 2) return;

    const lista = await buscarServidor(q);
    if (!lista.length) {
      alert('No se encontró un establecimiento que coincida.');
      return;
    }
    const nq = norm(q);
    const exact = lista.find(r => norm(r.eess_nombre) === nq);
    aplicarSeleccion(exact || lista[0]);
  });

  // 2) Si el usuario se va del campo y no se llenó IPRESS, intenta autocompletar con el 1er resultado
  $input.addEventListener('blur', async () => {
    if ($ipr.value) return;
    const q = $input.value.trim();
    if (q.length < 2) return;
    const lista = await buscarServidor(q);
    if (lista.length) aplicarSeleccion(lista[0]);
  });
</script>

<!-- Script 3: BUSCA el codigos patrimonial -->
<script>
(function(){
  const $cod  = document.getElementById('codigo_patrimonial');
  const $est  = document.getElementById('establecimiento');
  const $den  = document.querySelector('[name="denominacion_equipo_existente"]') || document.querySelector('#denominacion');
  const $marca= document.querySelector('[name="marca"]') || document.querySelector('#marca');
  const $modelo=document.querySelector('[name="modelo"]') || document.querySelector('#modelo');
  const $serie= document.querySelector('[name="serie"]') || document.querySelector('#serie');
  const $anti = document.querySelector('[name="antiguedad"]') || document.querySelector('#antiguedad');

  // util mínimo (quita tildes / minúsculas / espacios dobles)
  const clean = s => (s || "")
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ').trim().toLowerCase();

  let lastWarn = "";  // evita alert repetidos

  async function lookup(){
    const codigo = ($cod.value || "").replace(/\s+/g,"").trim();
    if (codigo.length !== 12) {
      console.log('[SIGA] código inválido:', codigo);
      return;
    }
    // NO mandamos “— 6104” ni nada extra; solo el nombre visible
    const establecimiento = ($est.value || "").trim();
    console.log('[SIGA] fetch →', {codigo, establecimiento});

    const res = await fetch('/api/siga/lookup', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ codigo, establecimiento })
    });
    const data = await res.json();
    console.log('[SIGA] resp ←', data);

    if (!data.ok) {
      // limpia campos
      if ($den)   $den.value   = '';
      if ($marca) $marca.value = '';
      if ($modelo)$modelo.value= '';
      if ($serie) $serie.value = '';
      if ($anti)  $anti.value  = '';

      // alerta solo una vez por valor
      if (lastWarn !== codigo) {
        alert(data.msg || 'No se encontró en SIGA ese código patrimonial.');
        lastWarn = codigo;
      }
      return;
    }

    // éxito: rellena
    if ($den)   $den.value   = data.denominacion || '';
    if ($marca) $marca.value = data.marca || '';
    if ($modelo)$modelo.value= data.modelo || '';
    if ($serie) $serie.value = data.serie || '';
    if ($anti)  $anti.value  = data.antiguedad || '';

    lastWarn = ""; // resetea para próximas búsquedas
  }

  // dispara al salir del campo o con Enter
  $cod.addEventListener('blur', lookup);
  $cod.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); lookup(); } });
})();
</script>

</html>
