<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formato 8 EQUIPAMIENTO</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="{{ url_for('static', filename='img/logominsa.png') }}" alt="logominsa">
    <div class="title">
      <div class="h1">Formato 8 Plan Multianual de Equipamiento</div>
      <div class="h2">OFICINA DE INFRAESTRUCTURA Y EQUIPAMIENTO — ING. ELECTÓNICO RONALD ZARPAN CASAS</div>
    </div>
  </div>
  <div class="header-actions">
    <a class="btn red" href="{{ url_for('auth.logout') }}">Salir</a>
  </div>
</header>

<div class="wrap">

  <div class="toast"><b>Emisión!</b> El Documento solo puede ser emitido por: <b>Firmado Por</b></div>

  <div class="card">
    <div class="card-head">
      <div class="title">EMISIÓN DE DOCUMENTOS ADMINISTRATIVOS</div>
      <div class="toolbar">
        <a class="btn blue" href="#">Grabar</a>
        <a class="btn blue" href="#">Firmar Doc.</a>
        <a class="btn" href="#">Ver / Cargar Anexos</a>
        <a class="btn" href="#">Cargar SIGA</a>
        <a class="btn gray" href="#">Anular</a>
        <a class="btn" href="#">Cerrar</a>
        <a class="btn red" href="{{ url_for('auth.logout') }}">Salir</a>
      </div>
    </div>

    <div class="card-body">

      <!-- Llenado de Unidad Ejecutora -->
      <section class="section">
        <div class="section-title">Datos de Unidad Ejecutora</div>
        <div class="grid cols-4">
          <div class="field"><label>Pliego</label><input id="pliego" name="pliego" type="text" value="{{ pliego_texto }}" readonly></div>
          <div class="field"><label>Unidad Ejecutora</label><input id="unidad_ejecutora" name="unidad_ejecutora" type="text" value="{{ ue_texto }}" readonly></div>
          <div class="field"><label>Código IPRESS</label><input id="ipress_codigo" name="ipress_codigo" type="text" readonly></div>

          <div class="field" style="position:relative">
            <label>Establecimiento de Salud</label>
            <input id="establecimiento" name="establecimiento" placeholder="Escribe para buscar..." autocomplete="off">
            <!-- contenedor de sugerencias -->
            <div id="eess_suggestions" class="suggestions hidden"></div>
          </div>

          <div class="field">
            <label>Categoria del EESS</label>
            <input id="categoria_eess" name="categoria_eess" type="text" readonly>
          </div>

        </div>
      </section>

      <!-- Llenado de datos del equipo-->
      <section class="section">
        <div class="row">
          <div class="section-title">Datos del equipo</div>
        </div>

        <div class="grid cols-3">
          <div class="field"><label>CODIGO PATRIMONIAL</label><input value="532220490064"></div>
          <div class="field"><label>AMBIENTE</label><input value="LABORATORIO"></div>
          <div class="field"><label>UNIDAD PRESTADORA DE SERVICIO DE SALUD (UPSS)</label><input value="UPSS PATOLOGIA CLINICA"></div>
          <div class="field"><label>DENOMINACION DEL EQUIPAMIENTO EXISTENTE</label><input value="CENTRIFUGA PARA TUBOS"></div>
          <div class="field"><label>MARCA</label><input value="HETTICH"></div>
          <div class="field"><label>MODELO</label><input value="ROTOFIX 32 A "></div>
          <div class="field"><label>SERIE / PLACA DE RODAJE</label><input value="D-78532"></div>
          <div class="field"><label>ANTIGUEDAD</label><input value="13.7"></div>
          <div class="field"><label>VIDA ÚTIL</label><input value="5"></div>
        </div>      

      <!-- Evaluación de Equipos -->
      <section class="section">
        <div class="section-title">Evaluación de Equipamiento</div>

        <div class="grid cols-4">
          <div class="field">
            <label>Tipo de Equipamiento</label>
            <select>
              <option>Biomedico</option>
              <option>Electromedicino</option>
              <option>Moviliario Clinico</option>
            </select>
          </div>
          <div class="field"><label>C1</label><input value="X"></div>
          <div class="field"><label>C2</label><input value="X"></div>
          <div class="field"><label>C3</label><input value="X"></div>
          <div class="field"><label>C4</label><input value="X"></div>
          <div class="field"><label>C5</label><input value="X"></div>
          <div class="field"><label>C6</label><input value="X"></div>
        </div>

        <div class="field" style="margin-top:8px">
          <label>Asunto</label>
          <textarea>SOLICITO REPARACION DE ESTERILIZADOR DEL SERVICIO DE ODONTOLOGIA DEL PS SAN ROQUE - EQUIPO OPERATIVO</textarea>
        </div>

        <div class="grid cols-4" style="margin-top:8px">
          <div class="field"><label>CONDICION DE SEGURIDAD (requiere informe tecnico)</label><input></div>
          <div class="field"><label>SUSTENTO DE EVALUACION (C2-C3-C4-C6-C7)</label><input ></div>
          <div class="field"></div>
          <div class="field"></div>
        </div>
      </section>

      <!-- PRESUPUESTO -->
      <section class="section">
        <div class="section-title">Presupuesto</div>

        <div class="grid cols-4">
          <div class="field">
            <label>PROGRAMA PRESUPUESTAL</label>
            <select>
              <option>0001</option>
              <option>0002</option>
              <option>0016</option>
              <option>0017</option>
              <option>0018</option>
              <option>0024</option>
              <option>0068</option>
              <option>0104</option>
              <option>0129</option>
              <option>0131</option>
              <option>1001</option>
            </select>
          </div>
          <div class="field">
            <label>PRODUCTO</label>
            <select><option>—</option></select>
          </div>
          <div class="field">
            <label>ACTIVIDAD</label>
            <select><option>—</option></select>
          </div>
          <div class="field">
            <label>GRUPO-CLASE-FAMILIA DEL EQUIPO A ADQUIRIR</label>
            <select><option>—</option></select>
          </div>
          <div class="field">
            <label>DENOMINACION DEL EQUIPAMIENTO A ADQUIRIR</label>
            <input placeholder="">
          </div>
          <div class="field">
            <label>COSTO REFERENCIAL  DEL EQUIPAMIENTO</label>
            <input placeholder="">
          </div>
          <div class="field">
            <label>PRIORIDAD MULTIANUAL (1 -AÑO 2023,2-AÑO 2024,3-AÑO 2025)</label>
            <select>
              <option>1</option>
              <option>2</option>
              <option>3</option>
            </select>
          </div>
        </div>

      <!-- FOOTER -->
      <div class="footer">
        <div>Equipo: Trámite Documentario — Versión 2.5</div>
        <div>Unidad Orgánica: OFICINA DE INFRAESTRUCTURA Y EQUIPAMIENTO — DIRIS LIMA SUR</div>
      </div>

    </div>
  </div>
</div>

</body>
<!-- Esto rellena los campos de pliego y UE-->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const pliego = "{{ pliego_texto|e }}";
  const ue = "{{ ue_texto|e }}";
  const $pliego = document.querySelector('#pliego, #pliego_input, [name="pliego"]');
  const $ue = document.querySelector('#unidad_ejecutora, #ue_input, [name="unidad_ejecutora"]');
  if ($pliego) { $pliego.value = pliego; $pliego.setAttribute('readonly', 'readonly'); }
  if ($ue) { $ue.value = ue; $ue.setAttribute('readonly', 'readonly'); }
});
</script>

<script>
  // Datos IPRESS de la UE logueada
  const EESS = {{ ipress_items | tojson }};

  const $input = document.getElementById('establecimiento');
  const $ipr   = document.getElementById('ipress_codigo');
  const $cat   = document.getElementById('categoria_eess');
  const $box   = document.getElementById('eess_suggestions');

  // normaliza: minúsculas y sin acentos
  const norm = s => (s || "")
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  let activeIndex = -1;   // para navegación con flechas

  function buildLabel(r) {
    return `${r.eess_nombre} — ${r.ipress_codigo}`;
  }

  function render(list) {
    if (!list.length) { $box.classList.add('hidden'); $box.innerHTML = ""; activeIndex = -1; return; }
    $box.innerHTML = list.map((r,i) => `
      <div class="suggestion-item" data-i="${i}">
        <strong>${r.eess_nombre}</strong>
        <span class="suggestion-secondary">${r.ipress_codigo}${r.eess_categoria ? ' · ' + r.eess_categoria : ''}</span>
      </div>
    `).join('');
    $box.classList.remove('hidden');
    activeIndex = -1;
  }

  function filter(query) {
    const q = norm(query);
    if (q.length < 2) { render([]); return; }
    // match por nombre o por código
    const out = [];
    for (const r of EESS) {
      const name = norm(r.eess_nombre);
      const code = String(r.ipress_codigo || "");
      if (name.includes(q) || code.includes(query)) {
        out.push(r);
        if (out.length >= 12) break;   // limita resultados
      }
    }
    render(out);
  }

  function selectByIndex(idx) {
    const items = $box.querySelectorAll('.suggestion-item');
    if (!items.length || idx < 0 || idx >= items.length) return;
    const r = currentList()[idx];
    applySelection(r);
  }

  function currentList() {
    // reconstruye desde DOM (simple y suficiente)
    const items = [...$box.querySelectorAll('.suggestion-item')];
    return items.map(el => {
      const i = parseInt(el.getAttribute('data-i'), 10);
      // usamos el mismo filtro que en render para mantener orden
      // (más simple: re-filtrar)
      const q = norm($input.value);
      const res = [];
      for (const r of EESS) {
        const name = norm(r.eess_nombre);
        const code = String(r.ipress_codigo || "");
        if (name.includes(q) || code.includes($input.value)) {
          res.push(r);
          if (res.length >= 12) break;
        }
      }
      return res[i];
    });
  }

  function applySelection(r) {
    if (!r) return;
    $input.value = buildLabel(r);
    $ipr.value   = r.ipress_codigo || '';
    $cat.value   = r.eess_categoria || '';
    hideBox();
  }

  function hideBox(){ $box.classList.add('hidden'); activeIndex = -1; }

  // Eventos
  $input.addEventListener('input', () => filter($input.value));

  $input.addEventListener('keydown', (e) => {
    const items = $box.querySelectorAll('.suggestion-item');
    if (e.key === 'ArrowDown') {
      if (items.length) {
        activeIndex = (activeIndex + 1) % items.length;
        items.forEach((el,i)=> el.classList.toggle('active', i===activeIndex));
      }
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      if (items.length) {
        activeIndex = (activeIndex - 1 + items.length) % items.length;
        items.forEach((el,i)=> el.classList.toggle('active', i===activeIndex));
      }
      e.preventDefault();
    } else if (e.key === 'Enter') {
      if (!$box.classList.contains('hidden') && activeIndex >= 0) {
        e.preventDefault();
        const list = currentList();
        applySelection(list[activeIndex]);
      }
    } else if (e.key === 'Escape') {
      hideBox();
    }
  });

  $box.addEventListener('mousedown', (e) => {
    const item = e.target.closest('.suggestion-item');
    if (!item) return;
    const idx = parseInt(item.getAttribute('data-i'), 10);
    const list = currentList();
    applySelection(list[idx]);
    e.preventDefault();
  });

  document.addEventListener('click', (e) => {
    if (!($box.contains(e.target) || $input.contains(e.target))) hideBox();
  });
</script>

</html>

